$(function(){if(config.debug){console.log(THREE);console.log(new THREE.Object3D())}window.scene;window.camera;var T,ac,S=$("#container");var o=false;var V=false;var O,R;var at;var v=0.5;var y=100,f=40;var X=1024;var ab=0,aa=0,Z=0;var j=false;var D=0,B=0;var g=0,e=0;var P=0,J=0;var au=0,x=0;var n,m;var ao=[];var am=true;var ak,ah,I,G;var ae,ad,E,C;var aq=THREE.Texture();var N="allinone.jpg";var l=[];var c=0;$(".item").click(function(){$(".check").addClass("hide");$(this).find(".check").removeClass("hide");$(".romaing-input").val($(this).attr("data-name"));$(".romaing-input").attr("data-id",$(this).attr("data-id"))});$(".edit-cancel").click(function(){$(".romaing-editor").hide();o=false});$(".edit-delete").click(function(){$.ajax({url:"/spot-delete",type:"POST",async:false,timeout:1000,data:{link_id:$(".romaing-editor").attr("current-id"),scene_id:config.scene_id},success:function(i){if(i.code!=0){alert(i.msg);return}$(".edit-cancel").click();scene.remove(scene.getChildByName("spot_id_"+$(".romaing-editor").attr("current-id")))},error:function(i){alert(i)}})});$(".edit-add").on("click",function(){if(!$(".romaing-input").attr("data-id")){alert("无法添加");return}var i={text:$(".romaing-input").val(),scene_id:config.scene_id,go_scene:$(".romaing-input").attr("data-id")};if($(".editor-modify").hasClass("hide")){i.position_x=at.x;i.position_y=at.y;i.position_z=at.z}else{i.link_id=$(".romaing-editor").attr("current-id")}$.ajax({url:"/spot-post",type:"POST",async:false,timeout:1000,data:i,success:function(av){if(av.code!="0"){alert(av.msg);return}if($(".editor-modify").hasClass("hide")){var aw=F("spot",$(".romaing-input").val(),av.id,"?",u);q(aw,at.x,at.y,at.z)}else{$("#spot_id_"+$(".romaing-editor").attr("current-id")).text($(".romaing-input").val())}$(".edit-cancel").click()},error:function(av){alert(av)}})});var H=[config.localImagesPath+"/negx.jpg",config.localImagesPath+"/negy.jpg",config.localImagesPath+"/negz.jpg",config.localImagesPath+"/posx.jpg",config.localImagesPath+"/posy.jpg",config.localImagesPath+"/posz.jpg"];for(var al=0;al<6;++al){var s;if(config.local){$(".loader").hide();s=document.createElement("img");s.height=X+2;s.width=X+2;s.src=H[al]}else{s=document.createElement("img");s.crossOrigin="*";s.height=X+2;s.width=X+2;s.src=config.cdnImagesPath+"/scenes/"+config.scene_id+"/"+N+"?v="+(new Date()).valueOf()+"&imageMogr2/gravity/NorthWest/crop/!"+X+"x"+X+"a0a"+(X*al)+"/thumbnail/!10p";s.onload=function(){c++;if(c==6){$(".loader").hide();for(var i in l){l[i].crossOrigin="*";l[i].src=config.cdnImagesPath+"/scenes/"+config.scene_id+"/"+N+"?v="+(new Date()).valueOf()+"&imageMogr2/gravity/NorthWest/crop/!"+X+"x"+X+"a0a"+(X*i)+"/thumbnail/!30p"}aj();af()}else{if(c==12){for(var i in l){l[i].crossOrigin="*";l[i].src=config.cdnImagesPath+"/scenes/"+config.scene_id+"/"+N+"?v="+(new Date()).valueOf()+"&imageMogr2/gravity/NorthWest/crop/!"+X+"x"+X+"a0a"+(X*i)+"/thumbnail/!100p"}}}}}s.style.zIndex=1;l.push(s)}if(config.local){aj();af()}function ag(){var az=X;var aA=[{position:[az/2,0,0],rotation:[0,-Math.PI/2,0]},{position:[0,-az/2,0],rotation:[-Math.PI/2,0,Math.PI]},{position:[0,0,-az/2],rotation:[0,0,0]},{position:[-az/2,0,0],rotation:[0,Math.PI/2,0]},{position:[0,az/2,0],rotation:[Math.PI/2,0,Math.PI]},{position:[0,0,az/2],rotation:[0,Math.PI,0]}];var aw=[];for(var ay=0;ay<aA.length;ay++){var ax=aA[ay];var av=new THREE.CSS3DObject(l[ay]);av.position.fromArray(ax.position);av.rotation.fromArray(ax.rotation);aw.push(av)}return aw}function t(){THREE.ImageUtils.crossOrigin="*";aq=THREE.ImageUtils.loadTexture(config.imgUrl);var av=new THREE.SphereGeometry(100,40,40);av.applyMatrix(new THREE.Matrix4().makeScale(-1,1,1));var i=new THREE.MeshBasicMaterial({map:aq});return new THREE.Mesh(av,i)}function r(i,aB,az,av,aw,ay){if(config.useCSS3D){}else{var ax=new THREE.Geometry();var aA=new THREE.LineBasicMaterial({vertexColrs:THREE.VertexColors});ax.vertices.push(new THREE.Vector3(i,aB,az));ax.vertices.push(new THREE.Vector3(av,aw,ay));ax.colors.push(new THREE.Color(4473924),new THREE.Color(16711680));return new THREE.Line(ax,aA,THREE.LinePieces)}}function h(av,aA,az,aw){var ay=new THREE.BoxGeometry(aw,aw,aw);var ax=new THREE.MeshBasicMaterial({color:65280});var i=new THREE.Mesh(ay,ax);i.position.x=av;i.position.y=aA;i.position.z=az;return i}function Y(){var av="#0c0c0c";var i=new THREE.AmbientLight(av);return i}function A(){var i=new THREE.SpotLight(16777215);i.position.set(40,60,10);i.castShadow=true;return i}function U(aF,aB,az,aJ,aG,aD){var aE=0.5,aC=1,ay=0.5,ax=1;var aw=[v3(-aJ*ay,0,0),v3(-aJ*ay,0,-aJ*aC),v3(aJ*ay,0,-aJ*aC),v3(aJ*ay,0,0),v3(aJ*ay+aJ*aE,0,0),v3(0,0,aJ*ax),v3(-aJ*ay-aJ*aE,0,0)];var av=[f3(2,1,0),f3(3,2,0),f3(6,5,4)];var aA=new THREE.Geometry();var aH=[new THREE.MeshLambertMaterial({opacity:0.6,color:16777215,transparent:true})];aA.vertices=aw;aA.faces=av;aA.computeFaceNormals();var aI=THREE.SceneUtils.createMultiMaterialObject(aA,aH);aI.children.forEach(function(aK){aK.castShadow=true});aI.position.x=aF;aI.position.y=aB;
aI.position.z=az;var i=Math.acos(az/Math.pow(aF*aF+az*az,0.5));if(aF<0){i=2*PI-i}aI.rotation.y=i+aG*PI/180;if(aD){aI.rotation.z=aD*PI/180}return aI}function ap(){ac=new Stats();ac.domElement.style.position="absolute";ac.domElement.style.top="0px";ac.domElement.style.zIndex="10000";return(ac.domElement)}function M(aC,aB,az,aE,aG){textWidth=text_length(aE)/2*aG;textHeight=aG;var ay=20;var aw=document.createElement("canvas");var av=aw.getContext("2d");aw.style.position="absolute";aw.width=textWidth;aw.height=textHeight;aw.style.bottom=0;aw.style.left=0;av=aw.getContext("2d");av.font=aG+"px impact";av.fillStyle="#fff";av.textAlign="center";av.shadowColor="rgba(0,0,0,1)";av.shadowOffestX=95;av.shadowOffestX=-90;av.textBaseline="middle";av.fillText(aE,textWidth/2,textHeight/2);var aA=new THREE.PlaneGeometry(av.measureText(aE).width/ay,aG/ay,1,1);var ax=new THREE.Texture(aw);var aD=new THREE.MeshBasicMaterial({map:ax,transparent:true});ax.needsUpdate=true;var aF=new THREE.Mesh(aA,aD);aF.position.set(aC,aB,az);var i=Math.acos(az/Math.pow(aC*aC+az*az,0.5));if(aC<0){i=2*PI-i}aF.rotation.y=i+PI;return aF}function L(){}function aj(){if(navigator.userAgent.indexOf("Android")!=-1){camera=new THREE.PerspectiveCamera(120,window.innerWidth/window.innerHeight,1,1000);S.css("-webkit-transform","scale("+(140/75)+")")}else{camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,1,1000)}camera.target=new THREE.Vector3(0,0,0);scene=new THREE.Scene();if(config.debug){S.append(ap())}if(config.useCSS3D){try{T=new THREE.CSS3DRenderer()}catch(ay){k(ay);alert("您的浏览器太捞")}var aw=ag();for(var av=0;av<aw.length;++av){ao.push(aw[av]);scene.add(aw[av])}if(!config.local){q(F("advertisement",config.advertisement,0,0,L),1,-100,1,-PI/2);for(var av=0;av<preload_links.length;++av){q(F("spot",preload_links[av].text,preload_links[av].id,av,u,preload_links[av].scene_id),preload_links[av].x,preload_links[av].y,preload_links[av].z)}if(preload_comments&&!config.isOwner){for(var av=0;av<preload_comments.length;++av){var ax=F("comment",preload_comments[av].text,preload_comments[av].id,av,w);q(ax,preload_comments[av].position_x,preload_comments[av].position_y,preload_comments[av].position_z)}}}}else{try{T=new THREE.WebGLRenderer()}catch(ay){k(ay);alert("您的浏览器太捞")}try{T.setPixelRatio(window.devicePixelRatio)}catch(ay){k(ay)}ao.push(t());scene.add(ao[0]);scene.add(U(20,-10,0,10,0,0));scene.add(U(20,-10,0,10,0,90));scene.add(U(20,-10,0,10,0,180));scene.add(U(20,-10,0,10,0,270));scene.add(Y());scene.add(A());scene.add(r(0,0,0,0,0,100));scene.add(r(0,0,0,0,100,0));scene.add(r(0,0,0,100,0,0))}T.setSize(window.innerWidth,window.innerHeight);S.append(T.domElement);if(checkMobile()){S.on("touchstart",an,false);S.on("touchmove",b,false);S.on("touchend",W,false)}else{S.on("mousedown",an,false);S.on("mousemove",b,false);S.on("mouseup",W,false)}if(config.debug){S.on("DOMMouseScroll",p,false);S.on("mousewheel",p,false);$("body").on("keydown",ar,false);S.on("dragover",function(i){i.preventDefault();i.dataTransfer.dropEffect="copy"},false);S.on("dragenter",function(i){document.body.style.opacity=0.5},false);S.on("dragleave",function(i){document.body.style.opacity=1},false);S.on("drop",function(az){az.preventDefault();var i=new FileReader();i.addEventListener("load",function(aA){ao[0].material.map.image.src=aA.target.result;ao[0].material.map.needsUpdate=true},false);i.readAsDataURL(az.dataTransfer.files[0]);document.body.style.opacity=1},false)}}function d(){camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();T.setSize(window.innerWidth,window.innerHeight);$(".alert-wrap").height(S.height())}function an(i){i.preventDefault();if(o){return false}j=true;onPointerDownPointerX=parseInt(i.clientX>=0?i.clientX:i.targetTouches[0].clientX);onPointerDownPointerY=parseInt(i.clientY>=0?i.clientY:i.targetTouches[0].clientY);onPointerDownLon=g;onPointerDownLat=P;n=onPointerDownPointerX;m=onPointerDownPointerY}function b(ax){if(o){return false}try{var i=parseInt(ax.clientX>=0?ax.clientX:ax.targetTouches[0].clientX);var aA=parseInt(ax.clientY>=0?ax.clientY:ax.targetTouches[0].clientY)}catch(ay){k(ay)}if(ax.touches&&ax.touches.length>1){if(am){Multix1=ax.touches[0].pageX;Multiy1=ax.touches[0].pageY;Multix2=ax.touches[1].pageX;Multiy2=ax.touches[1].pageY;am=false}else{Multix3=ax.touches[0].pageX;Multiy3=ax.touches[0].pageY;Multix4=ax.touches[1].pageX;Multiy4=ax.touches[1].pageY;var az=abs(Multix1-Multix2)+abs(Multiy1-Multiy2)-abs(Multix3-Multix4)-abs(Multiy3-Multiy4);var aw=1+abs(az/4);if(az>0){if(navigator.userAgent.indexOf("Android")!=-1){var av=parseFloat(getFloat(S.css("-webkit-transform")));av-=aw*0.02;av=av<1?1:av;S.css("-webkit-transform","scale("+av+")")}else{camera.fov=camera.fov+aw>y?y:camera.fov+aw;camera.updateProjectionMatrix()}}else{if(az<0){if(navigator.userAgent.indexOf("Android")!=-1){var av=parseFloat(getFloat(S.css("-webkit-transform")));av+=aw*0.02;S.css("-webkit-transform","scale("+av+")")}else{camera.fov=camera.fov-aw<f?f:camera.fov-aw;
camera.updateProjectionMatrix()}}}if(az!=0){am=true}}}else{if(j===true){var aw=0.2;g=(onPointerDownPointerX-i)*aw+onPointerDownLon;P=(aA-onPointerDownPointerY)*aw+onPointerDownLat}}}function z(av,aw,ax){var i;i=new THREE.Matrix4();i.makeRotationAxis(aw.normalize(),ax);av.matrix.multiply(i);av.rotation.setFromRotationMatrix(av.matrix)}function K(av,aw,ax){var i;i=new THREE.Matrix4();i.makeRotationAxis(aw.normalize(),ax);i.multiply(av.matrix);av.matrix=i;av.rotation.setFromRotationMatrix(av.matrix)}function ar(ay){if(!o){var aw=camera.target.x-camera.position.x;var av=camera.target.y-camera.position.y;var i=camera.target.z-camera.position.z;var ax=3;if(ay.keyCode==83){ab-=ax*aw;aa-=ax*av;Z-=ax*i}else{if(ay.keyCode==68){ab-=ax*i;Z+=ax*aw}else{if(ay.keyCode==65){ab+=ax*i;Z-=ax*aw}else{if(ay.keyCode==87){ab+=ax*aw;aa+=ax*av;Z+=ax*i}else{if(ay.keyCode==81){aa+=ax}else{if(ay.keyCode==69){aa-=ax}}}}}}}}function ai(){return new THREE.Matrix4()}var a=false;var u=function(i){if(!config.isOwner&&i[0].go_scene>0){location.href="/scene?id="+i[0].go_scene}else{$(".romaing-editor").show();$(".romaing-editor").find(".buttons").addClass("hide");$(".romaing-editor").find(".editor-modify").removeClass("hide");$(".romaing-editor").attr("current-id",getInt(i[0].id))}};var w=function(av){var ay=0.8;if(av.attr("class")=="img-hide"){var aw=scene.getObjectByName(av.parent().attr("id"));scene.remove(aw);a=true;return}else{if(av.attr("class").indexOf("comment")!=-1){if(a){a=false;return}if(av.attr("data-clicked")=="1"){av.attr("data-clicked","0");av.find(".img-hide").css("visibility","hidden");av.css("background-color","rgba(0,0,0,0.4)");var aw=scene.getObjectByName(av.attr("id"));for(var ax=12;ax<15;++ax){aw.matrix.elements[ax]/=ay}aw.matrixAutoUpdate=false;return}av.css("background-color","rgba(255,0,0,0.5)");if(!av.find(".img-hide").length){av.append($(".img-hide").parent().html());if(!checkMobile()){av.find(".img-hide").on("mouseup",function(az){var i=parseInt(az.clientX?az.clientX:az.changedTouches[0].clientX);var aA=parseInt(az.clientY?az.clientY:az.changedTouches[0].clientY);if(i==n&&aA==m){w($(this))}})}else{av.find(".img-hide").on("touchend",function(az){var i=parseInt(az.clientX?az.clientX:az.changedTouches[0].clientX);var aA=parseInt(az.clientY?az.clientY:az.changedTouches[0].clientY);if(i==n&&aA==m){w($(this))}})}}av.find(".img-hide").css("visibility","visible");av.attr("data-clicked","1");var aw=scene.getObjectByName(av.attr("id"));for(var ax=12;ax<15;++ax){aw.matrix.elements[ax]*=ay}aw.matrixAutoUpdate=false}}};function F(ay,aA,aB,aw,i,av){var ax=document.createElement("div");ax.innerHTML=aA;if(aB){ax.id=ay+"_id_"+aB}ax.className=ay+" index_"+aw;if(av){ax.go_scene=av}var az=function(aD){var aC=parseInt(aD.clientX?aD.clientX:aD.changedTouches[0].clientX);var aE=parseInt(aD.clientY?aD.clientY:aD.changedTouches[0].clientY);if(aC==n&&aE==m){aD.stopPropagation();i($(this))}};if(checkMobile()){ax.addEventListener("touchend",az)}else{ax.addEventListener("mouseup",az)}return ax}function q(ay,aD,aC,aA,aB){var av=Math.pow(aD*aD+aC*aC+aA*aA,0.5);var aw=new THREE.CSS3DObject(ay);aB=aB?aB:0;var aE=ai().setPosition(v3(0,0,-av*v));var az=function(i,aG){var aF=Math.acos(aG/Math.pow(i*i+aG*aG,0.5));return i<0?2*PI-aF:aF};if(aB){aw.matrix.makeRotationX(aB)}else{aw.matrix.makeRotationX(aC/av*PI/2)}aw.matrix.multiplyMatrices(ai().makeRotationY(az(aD,aA)+PI),aw.matrix);aw.matrix.elements[12]=aD;aw.matrix.elements[13]=aC;aw.matrix.elements[14]=aA;if(ay.id){aw.name=ay.id}for(var ax=0;ax<12;++ax){aw.matrix.elements[ax]*=v}aw.matrixAutoUpdate=false;scene.add(aw)}function W(aI){if(o){return false}am=true;try{var aA=parseInt(aI.clientX?aI.clientX:aI.changedTouches[0].clientX);var az=parseInt(aI.clientY?aI.clientY:aI.changedTouches[0].clientY)}catch(aJ){k(aJ)}j=false;if(aA==n&&az==m&&!config.local){var aC=new THREE.Vector2();aC.x=(aA/window.innerWidth)*2-1;aC.y=-(az/window.innerHeight)*2+1;if(config.useCSS3D){var aE=aA;var aD=az;var aH=camera.fov;var aw=window.innerWidth;var av=window.innerHeight;var aM=S.width();var aL=S.height();O=-(aE-aw/2)/av*aH*PI/180*window.innerHeight/aL;R=(av/2-aD)/av*aH*PI/180*window.innerWidth/aM;var ax=X/3;var aK=ai();var ay=new THREE.Matrix4().makeRotationY(O+PI/2);var aF=ay.multiply(ai().makeRotationZ(R));var aB=ai().fromArray(camera.matrix.clone().elements);aK.makeRotationY(-PI/2);aK.multiplyMatrices(aF,aK);aK.multiplyMatrices(aB,aK);at=v3(0,0,-ax*v).applyProjection(aK);o=true;if(config.isOwner){at.x*=0.8;at.y*=0.8;at.z*=0.8;$(".romaing-editor").show();$(".romaing-editor").find(".buttons").addClass("hide");$(".romaing-editor").find(".editor-add").removeClass("hide");if($(".item")){$(".item").eq(0).click()}}else{initAlert("comment",{title:"添加评论",buttons:[{text:"取消",className:"btn-comment-cancel",callBack:function(){$(".textarea-comment").blur();$(".alert-wrap").css("visibility","hidden");o=false}},{text:"发布",className:"btn-comment-post",color:"red",callBack:function(){if($(".textarea-comment").val().length==0){$(".textarea-comment").attr("placeholder","评论不能为空");
return}$(".textarea-comment").blur();$.ajax({url:"/comment-post",type:"POST",async:false,timeout:1000,data:{position_x:at.x,position_y:at.y,position_z:at.z,text:$(".textarea-comment").val(),reply_id:0,scene_id:config.scene_id},success:function(aN){if(aN.code!="0"){alert(aN.msg);return}$(".alert-wrap").css("visibility","hidden");var aO=F("comment",$(".textarea-comment").val(),aN.id,"?",w);q(aO,at.x,at.y,at.z);o=false},error:function(aN){alert(aN)}})}}]});$(".alert-wrap").css("visibility","visible")}return}else{var aG=new THREE.Raycaster();aG.setFromCamera(aC,camera);var i=aG.intersectObjects(ao);if(i.length==1){points=i[0].point;scene.add(U(points.x*0.85,points.y*0.85,points.z*0.85,10,0,0))}}}}function p(i){if(i.wheelDeltaY){camera.fov-=i.wheelDeltaY*0.05}else{if(i.wheelDelta){camera.fov-=i.wheelDelta*0.05}else{if(i.detail){camera.fov+=i.detail*1}}}camera.fov=camera.fov>y?y:camera.fov;camera.fov=camera.fov<f?f:camera.fov;camera.updateProjectionMatrix()}function k(i){console.log(i);$("#console").append(i)}function af(){requestAnimationFrame(af);if(!o){Q()}}function Q(){if(j===false&&V){g+=0.1}P=Math.max(-85,Math.min(85,P));au=THREE.Math.degToRad(90-P);x=THREE.Math.degToRad(g);camera.target.x=Math.sin(au)*Math.cos(x)+ab;camera.target.y=Math.cos(au)+aa;camera.target.z=Math.sin(au)*Math.sin(x)+Z;camera.position.z=Z;camera.position.y=aa;camera.position.x=ab;camera.lookAt(camera.target);camera.updateMatrix();T.render(scene,camera);if(config.debug){ac.update()}}});
