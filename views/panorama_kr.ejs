<html>
    <head>
        <meta charset="utf-8">
        <meta name="format-detection" content="telephone=no">
        <meta name="viewport" content=" user-scalable=no, initial-scale=1.0,minimum-scale=1.0, maximum-scale=1.0">
        <meta name="author" content="muwenhu@gmail.com">
        <title><%=title%></title>
        <link rel="stylesheet" type="text/css" href="/css/common.css">
        <link rel="stylesheet" type="text/css" href="/css/sti-pano.css">
        <link rel="stylesheet" type="text/css" href="/css/panorama.css">
        <link rel="stylesheet" type="text/css" href="/css/pc-editor.css">
        <link href="/css/bootstrap/css/bootstrap.min.css" rel="stylesheet">
        <link href="/css/bootstrap-datetimepicker.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="/css/layout.css" />
        <style>
            <%if(user_info.permission_hidetitle){%>
            .header{display:none;}
            .visited-wrap{display:none;}
            .options-wrap{display:none;}
            <%}%>

            html{background: url(http://7xk1dv.com1.z0.glb.clouddn.com/control/background.png) center no-repeat;background-attachment: fixed;  background-size:cover;overflow: auto;/*min-height: 780px;*/}
            body{background: none;height: 100%;/*min-height: 780px;*/font-family:"Microsoft YaHei" !important;}
            .clearfix:after{content:".";display:block;height:0;clear:both;visibility:hidden}
            .clearfix{*+height:1%;}
            .hide{display: none;}
            .show{display: block;}
            .center{margin:0 auto;}
            .sti-container{ width: 1280px;position: absolute;top: 0;left: 50%;margin-left: -640px;}
            .box{width: 100%; height: 100%; max-width: 1020px;margin: 0 auto;position: relative;}
            .icon{background: url(../images/tool.png) no-repeat;}
            .icon-wlogo{background-position: -1292px -667px;}
            .icon-rlogo{background-position: -1022px -667px;}
            .line{border-right: 1px solid #333;height: 20px;width: 0;margin-right: 8px;}

            
            .menubox{padding: 220px 0 60px;box-sizing:border-box;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;height:100%;overflow: auto;overflow-x: hidden; }
            #dashboard-menu{height:100%;overflow-y: auto;overflow-x: hidden;padding: 0; width: 200px;}
            #sidebar-nav{background-color: #df0024;}
            #sidebar-nav .logo{width:180px;position: absolute;left: 50%;margin-left:-90px;}
            #sidebar-nav .nav-logo{display: block;width: 85px;height: 94px;background-position: -708px -890px;margin:0 auto;margin-top: 5.8em;cursor: pointer;}
            #sidebar-nav .icon-list{background-position: 0px -940px; }
            #sidebar-nav .icon-rearch{background-position: -33px -940px; }
            #sidebar-nav .icon-setall{background-position: -66px -940px; }
            #sidebar-nav .icon-setaccount{background-position: -99px -940px; }
            #sidebar-nav .icon-management{width:48px;left: 10px; background-position: -132px -940px; }

            #dashboard-menu > li > a {width: 150px;height:100px;overflow: hidden;margin: 20px 15px;padding:0;background-color: #fff;position: relative;}
            #dashboard-menu > li > a  img{width: 100%;}
            #dashboard-menu .cover{position: absolute;top: 0;left: 0;width:100%;height: 100%;     background-color: #000;opacity: 0.5;}
            #dashboard-menu .active .cover{display: none}
            #dashboard-menu .active img{opacity: 0.75;}
            #dashboard-menu .sname{position: absolute;top: 0;left: 15px;width: 50px;text-align: center;height: 50px;line-height: 50px;background-color: #565656;}
            #dashboard-menu .sname:after{content: "";position: absolute;top: 100%;left: 0;width: 0px;height: 0px;border-left: 25px solid transparent;border-right: 25px solid transparent;border-bottom: 10px solid transparent;border-top: 0;border-left-color: #565656;border-right-color: #565656;}

            .content{box-sizing:border-box;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;min-height: 0px;height: 100%;padding: 0;}
            .pc-editor-wrap {display:block;height: 100%;width:90%; margin:0 auto;padding: 40px 0;background: none;}
            .tips{top:0;width: auto;padding: 0 20px;background-color: #d5d1c5;color:#dc001e;font-size: 16px;font-weight: 600;z-index: 1000;}
            .preview{padding: 0;position: relative;width: 100%;}

            .editor-nav-wrap{width: 100%;height: 100%;}
            .editor-sti-logo-wrap{display: none;}
            .btn-view{position: absolute;top: 0;width: 24px;border-radius:  0 10px 0 0;font-size: 14px;height: 70px;line-height: 17px;padding-top: 5px;}

            .btn-mode-wrap{top: 0;left: 100%;line-height: 17px !important;height: 100%;font-size: 14px !important;width: 24px;display: block;z-index: 0;}
            .btn-mode-add{padding:10px 0;width: 100%;height: 70px;top: 23%;position: absolute; font-size: 14px;line-height: 18px;background-color: #888;box-shadow: 1px 1px 3px #aaa;border-radius: 0 6px 0 0;}
            .btn-mode-del{padding:10px 0;width: 100%;top: 50%;position: absolute;height: 70px;font-size: 14px;line-height: 18px;background-color: #888;box-shadow: 1px 1px 3px #aaa;border-radius: 0 6px 0 0;}
            .btn-mode-add.selected, .btn-mode-del.selected{box-shadow: 1px 1px 3px #aaa;}

            .btn-finish{position: absolute;top: 100%;margin-top: -91px;width: 24px;height: 70px;border-radius: 0 6px 0 0;font-size: 14px;line-height: 18px;padding:10px 0;cursor: pointer;-moz-user-select: none;-webkit-user-select: none;user-select: none;}

            #sti-pano{z-index: 100;}
            .preview-pointer{z-index:1000;}
            .scene-list{height: 90px;overflow:hidden;}
            .iselector{width:50px;height: 50px !important}
            .icon.spot0, .icon.spot1, .icon.spot2, .icon.spot3, .icon.spot4, .icon.spot5, .icon.spot6, .icon.spot7, .icon.spot8, .icon.spot9{top:-44px;}
            .editor-switch-wrap{padding: 15px 10px 0px 10px;}
            .editor-switch{color: #fff;margin-right: 5px;}
            .editor-switch.on{background-color: #353535;}

            .mosaic{width: 80px;height: 80px;margin:10px;height:110px; background-size: 70%; background-repeat: no-repeat;background-color: #9a9a9a;background-position: 50% 15px;}
            .mosaic:after{bottom: 5px;width: 100%;text-align: center;color: #fff;}
            .mosaic-small{background-size: 60%;background-position: 50% 20px;}
            .mosaic-large{background-size: 80%;background-position: 50% 10px;}
            .romaing-name{margin-top: 35%;}

            .romaing-input{background: none;border:none;padding-left:20px;font-weight:600;}
            .listcontainer{overflow-x: auto;overflow-y: hidden;}

            #console{word-break:break-all;position:absolute;top:0;right:0;width:60px;background-color:rgba(255,255,255,0.5);z-index:10}
            .alert-wrap{width:100%;position:fixed;height:100%;left:0;top:0;z-index:10000;visibility:hidden;background-color:rgba(0,0,0,0.5);}
            .alert-td{}
            .alert{padding: 30px 40px;display:inline-block;background-color:#dedfdf;width:330px;padding: 30px 40px;}
            .alert .title{color:#303030;font-size: 18px;font-weight: 600; display:block;min-height:45px;font-size:16px;color:#565656;text-align: left;border-bottom:none;}
            .alert .contentbox{font-size:16px;word-break:break-all;min-height:200px;background-color: #fff;}
            .alert .contentbox img{width: 80%;height: auto;margin:0 20px; padding: 20px 0; }
            .buttons{display:block;margin: 30px auto 0;text-align: center;}
            .buttons .btn{max-width:100px;width: 30%;margin: 0 5%;height: 28px;line-height: 28px;text-align: center;border-radius: 5px;display: inline-block;padding: 0;}
            .buttons :last-child{margin-right:10px;}
            .alert .middle{font-size: 25px;font-weight: 800;color: #aaa;line-height: 200px;height:200px;position: relative;}
            .alert .inputbox{width: 70%;margin:0 auto;padding-top: 40px;}
            .alert .table{background-color: #dedfdf;font-size: 13px;}
            .alert .table .table-info{width: 100%}
            .alert .table .table-info tr{display: block;float:left;width:50%;margin: 10px 0;width: 45%;margin-right: 5%;}
            .alert .table .table-info td{padding: 0;width: calc(100%-40px)}
            .alert .table .table-info .tdhead{width: 70px;}
            .alert .table .table-info input{border-radius: 5px;border: 1px solid #565656;font-size: 14px;}
            .goback{height: 30px;text-align: right;display: none;}
            .goback a{text-decoration: none;}
            .h0{height: 0 !important;}

            .alertbox{position: relative;}
            .input_click{position: absolute;width: 100px;height: 30px;bottom: 0;right: 46px;opacity: 0;cursor: pointer;}
        </style>
        <script src="/js/zepto.min.js"></script>
        <script src="/js/template-native.js?v=<%=version%>"></script>
        <script src="/js/sti-common.min.js?<%=version%>"></script>
        <script src="/js/qrcode.min.js"></script>
        <script src="/js/qnuploader.js"></script>

        <script src="/js/sti-tour.js"></script>
        <script>
            template.config('openTag','<#');
            template.config('closeTag','#>');
            var is_360=0, type='';
            <%if(platform.indexOf('pc-ie')!=-1){%>
                if(navigator.userAgent.indexOf('Chrome')!=-1){
                    is_360=1; type='is_360';
                }
            <%}%>
        </script>
        <!-- global styles -->
        <!-- bootstrap -->
    </head>
    <body id="romaing">
        <!-- alert -->
        <%include alert%>

        <!-- sidebar --><!-- sidebar -->
    <div class="box">
        <div id="sidebar-nav">

            <div class="logo">
                <div class="icon nav-logo"  onClick="location.href='/'"></div>
            </div>
            <div class="menubox">
                <ul id="dashboard-menu">
                    <%for(var i in romaing){%>
                        <li class="<%if(romaing[i].key==sceneKey){%>active<%}%>">                
                            <a href="/scene?key=<%=romaing[i].key%>&mode=editor&viewer=kr&type=edit">
                                <img src="<%=cdnImagesPath%>/scenes/<%=romaing[i].key.split('_')[0]%>/allinone.jpg?imageMogr2/gravity/NorthWest/crop/!1024x800a0a500/interlace/0/thumbnail/!10p">
                                <div class="sname" <%if(romaing[i].name.length>4){%>style="line-height:22px !important;"<%}%>><%=romaing[i].name%></div>
                                <div class="cover"></div>
                            </a>
                        </li> 
                    <%}%>
                </ul>
            </div>
        </div>
        <!-- end sidebar -->

        <!-- main container -->
        <div class="content">

            <div class="goback">
                <a href="/romaing/list?groupkey=<%=groupKey%>">返回</a>
            </div>

            <!-- Loading Animation -->
            <div class="pc-editor-wrap">
                <div class="preview">
<!--                     <div class="tips">
                        点击任意位置开始放置漫游点
                    </div> -->
                    <div class="btn-mode-wrap horizontal">
                        <div class="editor-nav btn-finish" onClick="location.href='/romaing/list?groupkey=<%=groupKey%>'">
                            保存返回
                        </div>
                    </div>
                    <div class="editor-nav-wrap">
                        <div class="editor-sti-logo-wrap hcenter vcenter">
                            <div class="editor-sti-logo"></div>
                        </div>
                    </div>


                    <!-- pano container -->
                    <div id="sti-pano"></div>

                    <div class="preview-pointer"></div>
                </div>

                <div class="control-panel hide">
                    <!-- Editor -->
                    <div id="sti-editor" class="vertical h100">
                        <div class="horizontal editor-switch-wrap">
                            <div class="editor-switch editor-switch-romaing on">
                                添加场景指引
                            </div>
                            <div class="editor-switch off editor-switch-description" style="display:none">
                                添加文字介绍
                            </div>
                            <div class="editor-switch off editor-switch-mosaic">
                                添加马赛克
                            </div>
                        </div>
                        <div class="flex1">
                        <div id="editor-switch-romaing-content">
                            <%mainscene = romaing[0];width=80+romaing.length*95%>
                            <div class="listcontainer">
                                <div class="scene-list" style="width:<%=width%>px">
                                    <%for(var i in romaing){%>
                                        <div class="item" data-id="<%=romaing[i].id%>" data-scene="<%=romaing[i].key%>" data-name="<%=romaing[i].name%>" style="background-image:url(<%=cdnImagesPath%>/scenes/<%=romaing[i].key.split('_')[0]%>/allinone.jpg?imageMogr2/gravity/NorthWest/crop/!1024x1024a0a0/interlace/0/thumbnail/!10p);">
                                            <div class="romaing-name flex1 vcenter hcenter" >
                                                <%=romaing[i].name%>
                                            </div>
                                            <div class="icon check hide"></div>
                                        </div>
                                    <%}%>
                                </div>
                            </div>
                            <div class="horizontal padding10 marginbottom10 vcenter">
                                <div>场景指引名称:</div>
                                <div class="input-wrap flex1">
                                    <input class="romaing-input" disabled="true" placeholder="">
                                </div>
                            </div>
                            <div class="padding10">
                                <div>选择图标:</div>
                                <div class="iselector vertical vcenter hcenter checked" data-icon-type='0'>
                                    <div class="icon spot0"></div>
                                </div>
                                <div class="iselector vertical vcenter hcenter" data-icon-type='1'>
                                    <div class="icon spot1"></div>
                                </div>
                                <div class="iselector vertical vcenter hcenter" data-icon-type='2'>
                                    <div class="icon spot2"></div>
                                </div>
                                <div class="iselector vertical vcenter hcenter" data-icon-type='3'>
                                    <div class="icon spot3"></div>
                                </div>
                                <div class="iselector vertical vcenter hcenter" data-icon-type='4'>
                                    <div class="icon spot4"></div>
                                </div>
                                <div class="iselector vertical vcenter hcenter" data-icon-type='5'>
                                    <div class="icon spot5"></div>
                                </div>
                                <div class="iselector vertical vcenter hcenter" data-icon-type='6'>
                                    <div class="icon spot6"></div>
                                </div>
                                <div class="iselector vertical vcenter hcenter" data-icon-type='7'>
                                    <div class="icon spot7"></div>
                                </div>
                                <div class="iselector vertical vcenter hcenter" data-icon-type='8'>
                                    <div class="icon spot8"></div>
                                </div>
                                <div class="iselector vertical vcenter hcenter" data-icon-type='9'>
                                    <div class="icon spot9"></div>
                                </div>
                            </div>
                        </div>
                        <div id="editor-switch-description-content" style="display:none">
                            <div class="input-wrap" style="padding:10px">
                                <textarea placeholder="添加文字介绍" class="editor-textarea"></textarea>
                            </div>
                        </div>
                        <div id="editor-switch-mosaic-content" style="display:none;padding:10px;">
                            <div data-size="1" class="mosaic mosaic-small selected"></div>
                            <div data-size="2" class="mosaic mosaic-middle"></div>
                            <div data-size="3" class="mosaic mosaic-large"></div>
                        </div>
                        </div>
                        <div class="buttons margintop10">
                            <button class="btn gray flex1" id="sti-editor-cancel">取消</button>
                            <button class="btn red flex1" id="sti-editor-add">新增</button>
                        </div>
                    </div><!-- .sti-editor end -->
                </div>
            </div>
        </body>
    </div>
    <script>
    
        if(top!=self){
            $('.goback').show();
            $('.nav-logo').hide();
        }


        var scene_width = <%=infowidth%>;

        embedpano({swf:"tour.swf", xml:"/scene/editor-panoxml?scene_key=<%=sceneKey%>&width=<%=infowidth%>&is_360="+is_360+'&simple=<%=simple%>&platform=<%=platform%>', target:"sti-pano", html5:"prefer", id:"stipano", passQueryParameters:true});

        var krpano = document.getElementById("stipano"); 
            
        function webgl_detect(return_context)
        {
            if (!!window.WebGLRenderingContext) {
                var canvas = document.createElement("canvas"),
                     names = ["webgl", "experimental-webgl", "moz-webgl", "webkit-3d"],
                   context = false;
        
                for(var i=0;i<4;i++) {
                    try {
                        context = canvas.getContext(names[i]);
                        if (context && typeof context.getParameter == "function") {
                            // WebGL is enabled
                            if (return_context) {
                                // return WebGL object if the function's argument is present
                                return {name:names[i], gl:context};
                            }
                            // else, return just true
                            return true;
                        }
                    } catch(e) {}
                }
        
                // WebGL is supported, but disabled
                return false;
            }
        
            // WebGL not supported
            return false;
        }

        var view_rx=0, view_rx=0, view_fov=0;
        var position_x,position_y,position_z;
        var add_flag=1;
        var preview_clicking=false;
        var scene_width;

        var scene={
            id:"<%=mainscene.id%>",
            key:"<%=mainscene.key%>",
            groupkey:"<%=groupKey%>"
        };

        function deleteComment(id,name){

            if(isNaN(id))id=newspot[id];

            if(confirm('是否删除该马赛克')){
                $.ajax({
                    type:'post',
                    url:'/scene/delete_comment',
                    data:{
                        group_key:'<%=groupKey%>',
                        scene_id:'<%=sceneKey%>',
                        comment_id:id
                    },
                    async:false,
                    timeout:3000,
                    success:function(r){
                        if(name)krpano.call('set(hotspot['+name+'].visible, false);');
                        if(is_360){alert(r.msg);return};
                        $('.alert-wrap').css('visibility','visible');
                        initAlert(type,{
                            title:"提示",
                            content:'<div class="middle" style="font-size:20px;">'+r.msg+'</div>'
                        });
                        return;
                    },
                    error:function(){
                        // if(is_360){$('#sti-pano').addClass('h0');}
                        $('.alert-wrap').css('visibility','visible');
                        initAlert(type,{
                            title:"提示",
                            content:'<div class="middle" style="font-size:20px;">connect error</div>'
                        });
                    }
                });
            }
        }

        function deleteSpot(linkid,name){
            
            console.log(linkid);
            if(isNaN(linkid))linkid=newspot[linkid];


            if(confirm('确认删除该指引点？')){

                $.ajax({
                    type:'post',
                    url:'/scene/delete_spot',
                    data:{
                        link_id:linkid,
                        scene_id:scene.id,
                        scene_key:scene.key,
                        groupkey:scene.groupkey
                    },
                    async:false,
                    timeout:3000,
                    success:function(r){
                        if(r.code==0){
                            console.log(name);
                            krpano.call('copy(hotspot['+name+'].visible, false);')
                            // if(is_360){alert(r.msg);return;}
                            $('.alert-wrap').css('visibility','visible');
                            initAlert(type,{
                                title:"删除成功",
                                content:'<div class="middle">'+r.msg+'</div>'
                            });
                            return;
                        }
                        // $('#spot_'+editor.data.id).closest('.sprite').remove();
                    },
                    error:function(){
                        if(is_360){alert(r.msg);return;}
                        $('.alert-wrap').css('visibility','visible');
                        initAlert(type,{
                            title:"删除成功",
                            content:'<div class="middle">连接超时</div>'
                        });
                    }
                });
            }
        }

        function passRxandRy(rx, ry, fov, mouse_x, mouse_y, bool, width){
            // view_rx = -parseInt(rx)+0;
            // view_ry = -parseInt(ry)+0;
            // view_fov = fov;
            // var container_w = $('#sti-pano').width()+0;
            // var container_h = $('#sti-pano').height()+0;
            
            // if(bool=="click"){

            //     <%if(platform.indexOf('pc-webkit')>=0){%>
            //         position_x = -(fov/container_w)*(container_w/2-mouse_x)-view_rx;
            //         position_y = -(fov/container_w)*(container_h/2-mouse_y)-view_ry;
            //         previewClick(mouse_x, mouse_y);
            //     <%}else{%>
            //         position_x = -(fov/container_w)*(container_w/2-mouse_x)-view_rx-parseInt((10/container_w)*mouse_x);
            //         position_y = -(fov/container_w)*(container_h/2-mouse_y)-view_ry-parseInt((10/container_w)*mouse_y);
            //         var mouse_runtime_x = mouse_x*(1-(70/container_w));
            //         var mouse_runtime_y = mouse_y*(1-(35/container_h));
            //         previewClick(mouse_runtime_x, mouse_runtime_y);
            //     <%}%>
            //     position_y = position_y>90?90:position_y;
            //     position_y = position_y<-90?-90:position_y;
            // }                
        }

        function previewClick(x, y){
            if($('.btn-mode-add').hasClass('selected')&&(x+y>0)){
                $('.preview-pointer').show();
                $('.preview-pointer').css('left',x);
                $('.preview-pointer').css('top',y);
                // editor.show();
            }
        }

        function setView(ath, atv){
            $.ajax({
                type:'post',
                url:'/scene/set_view',
                data:{
                    key:"<%=mainscene.key%>",
                    rx:-ath,
                    ry:-atv,
                    is_new:1
                },
                success:function(r){
                    if(is_360){alert(r.msg);return;}
                    $('.alert-wrap').css('visibility','visible');
                    var msg;
                    r.code!=0?msg=r.msg:msg='设置默认视角成功';
                    initAlert(type,{
                        title:"提示",
                        content:'<div class="middle">'+msg+'</div>'
                    });
                }
            });
        }

        function previewMousemove(e){
            if(preview_clicking){
                editor.hide();
            }
        }

        function previewMousedown(e){
            preview_clicking=true;
            preview_x=e.layerX;
            preview_y=e.layerY;
        }
        
        var editor={
            dom:$('#sti-editor'),
            btnAdd:$('#sti-editor-add'),
            btnCancel:$('#sti-editor-cancel'),
            mode:'add',
            data:{type:0}
        };


        editor.show=function(dom){
            editor.dom.addClass('show');
            editor.dom.find('.item').removeClass('checked');
            editor.dom.find('.iselector').removeClass('checked');
            if(dom){
                var matrix=text2Matrix(dom.closest('.sprite').css('-webkit-transform'));
                editor.data={
                    id:dom.attr('data-id'),
                    scene:dom.attr('data-scene'),
                    type:dom.attr('data-type'),
                    text:dom.attr('data-text'),
                    x:0,
                    y:0,
                    z:-matrix[14]
                }

                editor.dom.find('.item[data-scene="'+sti.editor.data.scene+'"]').each(function(){
                        $(this).addClass('checked');
                        editor.dom.find('.romaing-input').val(editor.data.text);
                        editor.dom.find('.iselector[data-icon-type="'+editor.data.type+'"]').addClass('checked');
                });
            }else{
                editor.dom.find('.item').eq(0).addClass('checked');
                editor.dom.find('.romaing-input').val(editor.dom.find('.item').attr('data-name'));
                editor.dom.find('.iselector').eq(0).addClass('checked');
            }
            editor.dom.css('visibility','visible');
        }

        editor.hide=function hideeditor(){
            $('.preview-pointer').hide();
            editor.dom.removeClass('show');
            editor.dom.find('.item').removeClass('checked');
        }

        function hideeditor(){
            $('.preview-pointer').hide();
            editor.dom.removeClass('show');
            editor.dom.find('.item').removeClass('checked');
        }

        function myalert(a){
            alert('a:'+a);
        }
        

        var advertisement="http://qncdn.sz-sti.com/images/tools/logo_ie.png";
        advertisement=advertisement?advertisement:'速腾聚创';

        var spots="http://qncdn.sz-sti.com/images/tools/logo_ie.png";
        var comments=[];
        var top_ad="http://qncdn.sz-sti.com/images/tools/logo_ie.png";

        var moveRatio=0.3;
        if(isIpad()){
            moveRatio=0.2;
        }


        function switchMode(){
            $('.btn-mode-add').removeClass('selected');
            $('.btn-mode-del').removeClass('selected');
            $(this).addClass('selected');
            editor.mode=$(this)[0].className.indexOf('add')>=0?'add':'del';
            editor.hide();
        }

        var newspot = {};
        var addspotname;

        function savename(newname){
            if(newname&&!newspot[newname]){
                console.log(newname);
                addspotname = newname;
            }
        }

        function newaddSpot(ath, atv, arrow_type, go_scene, text){
            var data={
                text:text,
                position_x:ath,
                position_y:atv,
                position_z:0,
                scene_id:scene.id,
                is_new:1,
                type:arrow_type,
                groupkey:"<%=groupKey%>",
                go_scene:go_scene
            }

            $.ajax({
                type:'post',
                url:'/scene/add_spot',
                data:data,
                timeout:3000,
                async:false,
                success:function(r){
                        if(webgl_detect()){
                            $('.alert-wrap').css('visibility','visible');
                            initAlert('alert',{
                                title:"提示",
                                content:'<div class="middle" style="font-size:20px;">'+r.msg+'</div>'
                            });
                        }else{
                            alert(r.msg);
                        }
                        newspot[addspotname]=r.id;
                        return;
                },
                error:function(){
                    alert('Time out');
                }
            });
        };

        function add_comment(ath, atv, size){
            $.ajax({
                type:'POST',
                url:'/scene/add_comment',
                data:{
                    position_x:ath,
                    position_y:atv,
                    position_z:0,
                    reply_id:0,
                    scene_key:'<%=sceneKey%>',
                    group_key:"<%=groupKey%>",
                    is_new:1,
                    //type:editor.data.type,
                    type:7,//7表示马赛克
                    is_description:0,
                    is_mosaic:size
                },
                timeout:3000,
                async:false,
                success:function(r){
                    if(r.code!=0){
                        if(webgl_detect()){
                            $('.alert-wrap').css('visibility','visible');
                            initAlert('alert',{
                                title:"提示",
                                content:'<div class="middle" style="font-size:20px;">'+r.msg+'</div>'
                            });
                        }else{
                            alert(r.msg);
                        }
                    }else{
                        newspot[addspotname]=r.id;
                        if(webgl_detect()){
                            $('.alert-wrap').css('visibility','visible');
                            initAlert('alert',{
                                title:"提示",
                                content:'<div class="middle" style="font-size:20px;">添加马赛克成功</div>'
                            });
                        }else{
                            alert('添加马赛克成功');
                        }
                    }
                    return;
                },
                error:function(){
                    if(webgl_detect()){
                        $('.alert-wrap').css('visibility','visible');
                        initAlert('alert',{
                            title:"提示",
                            content:'<div class="middle" style="font-size:20px;">error</div>'
                        });
                    }else{
                        alert('connect error');
                    }
                    return;
                }
            });
            return;
        }

        function callcomment(atv, ath){
            position_x = parseInt(ath*1000)/1000;
            position_y = parseInt(atv*1000)/1000;
            if(is_360){$('#sti-pano').addClass('h0');}
            $('.alert-wrap').css('visibility','visible');
            initAlert(type,{
                title:'上传图片评论',
                content:'<div class="middle">点击按钮上传图片</div><canvas id="myCanvas" width="550" height="200" style="display:none;max-width:"></canvas><input class="input_click" onChange=upcomment() type="file" id="input-file"/>',
                buttons:[
                {
                    text:'取消',
                    callBack:canceladdimg
                },{
                    text:'上传',
                    color:'red',
                    callBack:upload
                }
                ]
            }); 
        }

        function canceladdimg(){
            $('.alert-wrap').css('visibility','hidden');
            $('#sti-pano').removeClass('h0');
            krpano.call("add_img_cancel();");
        }

        function upload(){
            // krpano.call("add_img_sure();");
            // $('.alert-wrap').css('visibility','hidden');
            // return;
            $('#input-file').click();
        };

        var hasup = 0;

        function upslogan(){

            if(hasup){return;}
            hasup=1;

            $.post('/upload/slogan/token',{
                position_x:position_x,
                position_y:position_y,
                scene_key:'<%=sceneKey%>',
                groupid:"<%=group_info.id%>"
            },function(res){
                // return;
                var token = res.token;
                var key = res.key;
                var id = res.id;
                Q.addEvent("progress", function(p, s) {
                    update((p==100?99:p)+'%', s);
                });
                Q.addEvent("putFinished", function(fsize, res, taking) {
                    uploadSpeed = 1024 * fsize / (taking * 1000);
                    if (uploadSpeed > 1024) {
                        formatSpeed = (uploadSpeed / 1024).toFixed(2) + "Mb\/s";
                    } else {
                        formatSpeed = uploadSpeed.toFixed(2) + "Kb\/s";
                    };
                    var res = {
                        key: res.key,
                        hash: res.hash,
                        speed: formatSpeed
                    };
                    update('上传成功');
                    hasup=0;

                    var url = 'http://qncdn.sz-sti.com/'+key;
                    var name = 'imgcomment'+id;
                    krpano.call("add_img_sure("+url+", "+id+", "+name+");");
                    
                    setTimeout(function(){
                        if(is_360){$('#sti-pano').removeClass('h0');}
                        $('.alert-wrap').css('visibility','hidden');
                    }, 500);
                    // location.reload();
                });
                Q.SetToken(token);
                var data = document.getElementById("myCanvas").toDataURL('image/png').replace("data:image/png;base64,", "");
                Q.Upload_base64(data, key);
            });
        };

        function upcomment(){
            $('.contentbox .middle').hide();
            $('#myCanvas').show();
            $('.buttons .btn.red').remove();
            $('.alertbox .buttons').append($('<button class="btn red flex1" onClick="upslogan()">确定</button>'));
            var src = getObjectUrl(document.getElementById("input-file").files[0]);
            render(src);
            $('#input-file').hide();
        }

        function update(a,b){
            $('#myCanvas').hide();
            $('.middle').show().text(a+' '+(b?b:''));
        }

        function getObjectUrl(file){
            var url = undefined;
            if (window.createObjectURL) {
                url = createObjectURL(file);
            }else if(window.URL){
                url = URL.createObjectURL(file);
            }else if(window.webkitURL){
                url = webkitURL.createObjectURL(file);
            }
            return url;
        }


        function render(src){

            var image = new Image();
            image.crossOrigin = "*";

            image.onload = function(){

                var canvas = document.getElementById("myCanvas");
                var ctx = canvas.getContext("2d");

                if(image.width > 550){
                    image.height = image.height*550/image.width;
                    image.width = 550;
                }
                if(image.height > 666){
                    image.width = image.width*666/image.height;
                    image.height = 666;
                }
                canvas.style.width=image.width*3/5;
                canvas.style.height=image.height*3/5;

                canvas.height = image.height;
                canvas.width = image.width;
                var margintop = (333-(image.height*(550/image.width)))/2;
                margintop=image.height*(550/image.width)>333?0:margintop;
                $(canvas).css({'margin-top':margintop});


                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if(image.height > image.width) {
                    // image.height *= MAX_HEIGHT / image.width;
                    // image.width = MAX_HEIGHT;
                    ctx.drawImage(image, 0, 0, image.width, image.height);
                }else{
                    // image.width *= MAX_HEIGHT / image.height;
                    // image.height = MAX_HEIGHT;
                    ctx.drawImage(image, 0, 0, image.width, image.height);
                }

                $(".upshow").show();
                $(".tramarkbox").hide();
            };

            image.src = src;
        };

        editor.addSpot=function(){
            $('.preview-pointer').hide();
            if(!editor.dom.hasClass('show')){
                return;
            }
            $('.iselector').each(function(){
                if($(this).hasClass('checked')){
                    editor.data.type=$(this).attr('data-icon-type');
                }
            });
            editor.data.text=editor.dom.find('.romaing-input').val();
            // editor.data.position_x=position_x;
            // editor.data.position_y=position_y;
            editor.data.position_z=0;
            editor.data.scene_id=scene.id;
            editor.data.is_new=1;
            editor.data.groupkey="<%=groupKey%>";
            editor.data.go_scene=editor.dom.find('.item.checked').attr('data-id');


            //如果是添加马赛克
            if($('.editor-switch-mosaic').hasClass('on')){
                var text=$('.editor-textarea').val();
                $.ajax({
                    type:'POST',
                    url:'/scene/add_comment',
                    data:{
                        // position_x:position_x,
                        // position_y:position_y,
                        position_z:0,
                        reply_id:0,
                        scene_key:'<%=sceneKey%>',
                        group_key:"<%=groupKey%>",
                        is_new:1,
                        text:text,
                        //type:editor.data.type,
                        type:7,
                        is_description:$('.editor-switch-description').hasClass('on')?1:0,
                        is_mosaic:$('.mosaic.selected').attr('data-size')
                    },
                    timeout:3000,
                    async:false,
                    success:function(r){
                        if(r.code!=0){
                            if(is_360){alert(r.msg);return;}
                            $('.alert-wrap').css('visibility','visible');
                            initAlert(type,{
                                title:"提示",
                                content:'<div class="middle" style="font-size:20px;">'+r.msg+'</div>'
                            });
                        }else{
                            removepano("stipano");
                            embedpano({swf:"tour.swf", xml:"/scene/editor-panoxml?scene_key=<%=sceneKey%>&width="+scene_width+"&rx="+position_x+"&ry="+position_y, target:"sti-pano", html5:"prefer", id:"stipano", passQueryParameters:true});
                        }
                        return;
                    },
                    error:function(){
                        if(is_360){alert(r.msg);return;}
                        $('.alert-wrap').css('visibility','visible');
                        initAlert(type,{
                            title:"提示",
                            content:'<div class="middle" style="font-size:20px;">error</div>'
                        });
                        return;
                    }
                });
                return;
            }

            //如果是添加漫游点
            if(editor.data.scene_id==editor.data.go_scene){
                if(is_360){alert(r.msg);return;}
                $('.alert-wrap').css('visibility','visible');
                initAlert(type,{
                    title:"提示",
                    content:'<div class="middle" style="font-size:20px;">该场景与当前场景相同，不能添加</div>'
                });
                return false;
            }

            $.ajax({
                type:'post',
                url:'/scene/add_spot',
                data:editor.data,
                timeout:3000,
                async:false,
                success:function(r){
                    removepano("stipano");
                    embedpano({swf:"tour.swf", xml:"/scene/editor-panoxml?scene_key=<%=sceneKey%>&width="+scene_width+"&rx="+position_x+"&ry="+position_y, target:"sti-pano", html5:"prefer", id:"stipano", passQueryParameters:true});
                },
                error:function(){
                    alert('Time out');
                }
            });
        }
        editor.changeScene=function(){
            editor.dom.find('.item').removeClass('checked');

            var self=$(this);
            self.addClass('checked');
            editor.dom.find('.romaing-input').val(self.attr('data-name'));
            //editor.dom.find('.iselector').removeClass('checked');
            //editor.dom.find('.iselector').eq(0).addClass('checked');
        }
        
        editor.changeIcon=function(){
            editor.dom.find('.iselector').removeClass('checked');
            $(this).addClass('checked');
        }

        function changeScene(key){
            $('#switch-maps').removeClass('on');
            $('#switch-maps').addClass('off');
            $('.maps-wrap').hide();
            sti.sceneKey=key;
            $('.map-spot').removeClass('current');
            $(this).addClass('current');
            getSceneInfo(sti.sceneKey);
        }
        function editorSwitch(){
            $('.editor-switch').removeClass('on');
            $('.editor-switch').addClass('off');
            $(this).addClass('on');
            if($(this).hasClass('editor-switch-romaing')){
                $('#editor-switch-romaing-content').show();
                $('#editor-switch-mosaic-content').hide();
                $('#editor-switch-description-content').hide();
            }else if($(this).hasClass('editor-switch-description')){
                $('#editor-switch-romaing-content').hide();
                $('#editor-switch-mosaic-content').hide();
                $('#editor-switch-description-content').show();
            }else if($(this).hasClass('editor-switch-mosaic')){
                $('#editor-switch-romaing-content').hide();
                $('#editor-switch-description-content').hide();
                $('#editor-switch-mosaic-content').show();
            }
        }

        function sliderSwitch(){
            if($('.slider-wrap').hasClass('show')){
                $('.slider-wrap').removeClass('show');
            }else{
                $('.slider-wrap').addClass('show');
            }
        }

        function sliderClick(){
            location.href='/scene?key='+$(this).attr('data-key')<%if(user_info.permission_hidetitle){%>+'&hideheader=1'<%}%>;
        }

        function mosaicSwitch(){
            $('.mosaic').removeClass('selected');
            $(this).addClass('selected');
        }

        var preview_x=0;
        var preview_y=0;

        $('.slider-btn').on('click',sliderSwitch);
        $('.slider').on('click',sliderClick);
        editor.btnCancel.on('mouseup',editor.hide);
        editor.btnAdd.on('mouseup',editor.addSpot);
        editor.dom.find('.item').on('mouseup',editor.changeScene);
        $('.iselector').on('mouseup',editor.changeIcon);
        $('.btn-mode-add').on('mouseup',switchMode);
        $('.btn-mode-del').on('mouseup',switchMode);
        $('.btn-view').on('mouseup',setView);
        $('.editor-switch').on('mouseup',editorSwitch);
        $('.mosaic').on('click',mosaicSwitch);
        $('.preview-pointer').on('click',editor.hide);
        if($('.preview').length){
            $('.preview')[0].addEventListener('mousedown',previewMousedown,true);
            $('.preview')[0].addEventListener('mousemove',previewMousemove,true);
            $('.preview')[0].addEventListener('mouseup',function(){preview_clicking=false;},true);
        }

        if($('.control-panel').length){
            $('.control-panel')[0].addEventListener('click',function(e){if(!$('#sti-editor').hasClass('show')){alert("请先点击场景中任意位置添加漫游");e.stopPropagation();}},true);
        }
    </script>


    <script id="filter-html" type="text/html">
        <div class="form-group">
            <div style="text-align:start;margin-bottom:3px;">创建时间:</div>
            <div class="input-group date form_date_start" data-date="" data-date-format="yyyy-mm-dd" data-link-field="dtp_input2" data-link-format="yyyy-mm-dd">
                <input class="form-control" size="16" type="text" value="<#=start_created_time#>" readonly>
                <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
            </div>
            <input type="hidden" id="dtp_input2" value="" />
        </div>
        <div class="form-group">
            <div class="input-group date form_date_end" data-date="" data-date-format="yyyy-mm-dd" data-link-field="dtp_input3" data-link-format="yyyy-mm-dd">
                <input class="form-control" size="16" type="text" value="<#=end_created_time#>" readonly>
                <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
            </div>
            <input type="hidden" id="dtp_input3" value="" />
        </div>
        <div class="horizontal vcenter">
            <div>城&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;市：</div>
            <div class="input-warp" style="padding:3px;">
                <input class="filter-city" placeholder="不限" value="<#=city#>">
            </div>
        </div>
        <div class="horizontal vcenter">
            <div>区&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;域：</div>
            <div class="input-warp" style="padding:3px;">
                <input class="filter-region" placeholder="不限" value="<#=region#>">
            </div>
        </div>
        <div class="horizontal vcenter">
            <div>小&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;区：</div>
            <div class="input-warp" style="padding:3px;">
                <input class="filter-community" placeholder="不限" value="<#=community#>">
            </div>
        </div>
        <div class="horizontal vcenter">
            <div>朝&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;向：</div>
            <div class="input-warp" style="padding:3px;">
                <input class="filter-face" placeholder="不限" value="<#=face#>">
            </div>
        </div>
        <div class="horizontal vcenter">
            <div>面&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;积：</div>
            <div class="flex1" style="padding:3px;">
                <input class="filter-min-area" type="tel" placeholder="不限" value="<#=min_area#>">
            </div>
            <div>~</div>
            <div class="flex1" style="padding:3px;">
                <input class="filter-max-area" type="tel" placeholder="不限" value="<#=max_area#>">
            </div>
            <div>㎡</div>
        </div>
        <div class="horizontal vcenter">
            <div>房&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;型：</div>
            <div class="flex1" style="padding:3px;">
                <input class="filter-halls" placeholder="不限" value="<#=apartment_halls#>">
            </div>
            <div>房</div>
            <div class="flex1" style="padding:3px;">
                <input class="filter-rooms" placeholder="不限" value="<#=apartment_rooms#>">
            </div>
            <div>室</div>
            <div class="flex1" style="padding:3px;">
                <input class="filter-bathrooms" placeholder="不限" value="<#=apartment_bathrooms#>">
            </div>
            <div>卫</div>
        </div>
    </script>
</html>
